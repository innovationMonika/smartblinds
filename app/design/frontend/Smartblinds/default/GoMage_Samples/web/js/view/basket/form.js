define(["underscore","jquery","mage/translate","uiComponent","sampleBasket","mage/apply/main","Magento_Customer/js/customer-data","knockout","uuidv4.min","mage/validation","mage/cookies"],function(r,s,a,f,d,h,l,p,g){"use strict";var c=s(window),n;return f.extend({initialize:function(){return this.urls={},this.formId=null,this._super().initElements().initVariables().initEvents(),this.setFormData(l.get("customer")()),this},initObservable:function(){return this._super().observe(["items","createAccount","customerEmail","errorMessage","successMessage","isLoading","country","prefix","isSubscribed"].join(" "))},initElements:function(){return this.$form=s(this.selectors.form),this.$password=s(this.selectors.password),this},initVariables:function(){return this.updateBasketItems(),this.initFormDefaults(),this},initEvents:function(){return c.on("sample-basket-updated",this.updateBasketItems.bind(this)),l.get("customer").subscribe(this.setFormData.bind(this)),c.on("beforeunload",this.updateFormData.bind(this)),this},updateBasketItems:function(){this.items(d.getSimpleItems())},initFormDefaults:function(){this.country(this.defaults.countryId),this.prefix(this.defaults.prefix),this.createAccount(!1),this.isSubscribed(!1),this.customerEmail(null)},updateFormData:function(){let t=JSON.stringify(s("#sampleFormId").serializeArray()),e=new Date(new Date().getTime()+86400);s.mage.cookies.set("sample_form_data",t,{expires:e,domain:""})},setFormData:function(t){t||(t={}),this.customerEmail(t.email);var e=t.hasOwnProperty("samplesFormData")?t.samplesFormData:{};e.country&&this.country(e.country),e.prefix&&this.prefix(e.prefix);let o=s.mage.cookies.get("sample_form_data");if(o){o=JSON.parse(o);let m=this;r.each(o,function(i,b){(!e[i.name]||e[i.name].length===0)&&(e[i.name]=i.value),i.name==="is_subscribed"&&i.value==="on"&&m.isSubscribed(!0)})}var u={postcode:e.postcode,house:e.house,apartment:e.apartment,street:e.street,city:e.city,firstname:e.firstname,middlename:e.middlename,lastname:e.lastname,telephone:e.telephone,email:e.email};if(this.formData){r.each(u,function(m,i){this.formData[i](m)}.bind(this));return}this.formData={},r.each(u,function(m,i){this.formData[i]=p.observable(m)}.bind(this))},onSubmit:function(){this.isLoading()||(this.setValidationMessages(this.$form),this.$form.valid()&&(this.prepareFormSubmit(),this.submitForm(),s.mage.cookies.clear("sample_form_data")))},prepareFormSubmit:function(){this.errorMessage(""),s(this.$form[0]).find(".valid").removeClass("valid"),this.isLoading(!0),this.formId=g()},submitForm:function(){n=this.getSendData(),s.ajax({type:"POST",url:this.urls.placeOrder,contentType:"application/json",dataType:"json",data:JSON.stringify({info:n}),success:this.handleSuccessResponse.bind(this),error:this.handleErrorResponse.bind(this)})},getSendData:function(){var t=r.mapObject(this.formData,function(e){return e()?e():null});return t.form_id=this.formId,t.country_id=this.country(),t.prefix=this.prefix()?this.prefix():null,t.create_account=this.createAccount(),this.createAccount()&&(t.password=this.$password.find("#password").val()),t.items=r.map(this.items(),function(e){return r.pick(e,"id","name")}),t},handleSuccessResponse:function(t){if(this.isLoading(!1),this.afterSubmit(),!t.success){this.errorMessage(t.message);return}this.resetForm();var e=a("Your samples claim required has been accepted. Order ID: %1").replace("%1",t.message);this.successMessage(e),this.errorMessage(""),this.formId=null,d.clear(),n&&n.email&&(dataLayer.push({email:n.email,event:"fireEnhancedConversionTag"}),typeof _paq!="undefined"&&_paq.push(["trackGoal",1])),l.invalidate(["customer"])},handleErrorResponse:function(){this.isLoading(!1),this.errorMessage(a("Unexpected error has occurred. Please try again later."))},afterSubmit:function(){var t=[];t=r.map(this.items(),function(e){return{name:e.name}}),typeof dataLayer!="undefined"&&dataLayer.push({event:"Sample Request",eventCategory:"lead",eventAction:"sample_request",eventLabel:JSON.stringify(t),sampleFormId:this.formId})},onRender:function(){this.$form.validate(),this.$password.length&&h.applyFor(this.$password,{},"passwordStrengthIndicator")},resetForm:function(){this.initFormDefaults(),r.each(this.formData,function(t,e){t(null)}.bind(this))},setValidationMessages:function(t){var e=[{field:"#firstname",messages:{required:a("Do not forget to fill in your first name")}},{field:"#lastname",messages:{required:a("Don't forget to fill in your surname")}},{field:"#email",messages:{required:a("Don't forget to fill in your e-mail address")}},{field:"#postcode",messages:{required:a("Don't forget to fill in your postal code")}},{field:"#house",messages:{required:a("Do not forget to fill in your house number")}},{field:"#street",messages:{required:a("Don't forget to fill in your street name")}},{field:"#city",messages:{required:a("Don't forget to fill in your city of residence")}}];s.each(e,function(o,u){t.find(u.field).rules("add",{messages:u.messages})})}})});
