define(["jquery","Magento_Catalog/js/price-utils","uiRegistry","underscore","mage/template","jquery-ui-modules/widget"],function(a,u,w,c,f){"use strict";return a.widget("mageworx.optionBase",{options:{optionConfig:{},systemConfig:{},productConfig:{},productQtySelector:"#qty",productPriceInfoSelector:".product-info-price",mageworxAdditionalPriceInfoSelector:".mageworx-product-final-price",extendedOptionsConfig:{},priceHolderSelector:".price-box",dateDropdownsSelector:"[data-role=calendar-dropdown]",optionsSelector:".product-custom-option",optionHandlers:{},optionTemplate:"<%= data.label %><% if (data.finalPrice.value) { %> +<%- data.finalPrice.formatted %><% } %>",controlContainer:"dd",priceTemplate:'<span class="price"><%- data.formatted %></span>',localePriceFormat:{},productFinalPriceExclTax:0,productRegularPriceExclTax:0,productFinalPriceInclTax:0,productRegularPriceInclTax:0,configUrl:"",priceDisplayMode:0,catalogPriceContainsTax:!1,configurableContainerSelector:"[data-role=swatch-options]",configurableSelector:".swatch-option"},updaters:{},_init:function(){var t=this;c.each(this.updaters,function(e,n){try{t.triggerAfterInitPrice(t.getUpdater(n))}catch(i){console.log("Error:"),console.log(i)}}),this.processApplyChanges()},onUpdatePrice:function(t,e){return this.updatePrice(e)},_create:function(){var t=this;a(document).ready(function(){w.set("mageworxOptionBase",t);var e=w.get("mageworxOptionUpdaters");e||(e={});var n=Object.keys(e).sort(function(i,o){return i-o});a.each(n,function(i,o){!e.hasOwnProperty(o)||t.addUpdater(o,e[o])}),t.addOptionChangeListeners(),a("#product-options-wrapper").show()})},addUpdater:function(t,e){var n,i=this;try{n=this.getUpdater(t)}catch{n=null}if(n){if(n.options=e.options,i.options.productId!=window.productId&&!i.options.isInUpdateProcess)i.getBaseConfig().then(function(o){try{i.runUpdater(n)}catch(r){console.log("Error:"),console.log(r)}}).catch(function(o){console.log(o)});else if(i.options.productId==window.productId)try{i.runUpdater(n)}catch(o){console.log("Error:"),console.log(o)}}else{this.updaters[t]=e;try{n=this.getUpdater(t),this.runUpdater(n)}catch(o){console.log("Error:"),console.log(o)}}},getBaseConfig:function(){var t=this;return t.options.isInUpdateProcess=!0,new Promise(function(e,n){a.ajax({url:t.options.configUrl,data:{productId:window.productId},success:function(i){a.each(i,function(o,r){t.options[o]=JSON.parse(r)}),t.options.isInUpdateProcess=!1,e(i)},error:function(i){t.options.isInUpdateProcess=!1,n(i)}})})},getUpdater:function(t){if(c.isUndefined(this.updaters[t]))throw"Undefined updater with name: "+t;return this.updaters[t]},runUpdater:function(t){var e=t.firstRun;typeof e!="undefined"&&e&&e instanceof Function&&e.apply(t,[this.options.optionConfig,this.options.productConfig,this,t])},triggerAfterInitPrice:function(t){var e=t.afterInitPrice;typeof e!="undefined"&&e&&e instanceof Function&&e.apply(t,[this.options.optionConfig,this.options.productConfig,this,t])},addOptionChangeListeners:function(){var t=this;a(this.options.optionsSelector,this.getFormElement()).on("change",this.optionChanged.bind(this));var e=a(this.options.configurableContainerSelector);e.on("click",this.options.configurableSelector,function(){(t.isAnyOptionSelected()||t.isNonSelectableOptionsUsed())&&t.processApplyChanges()}),a("body").on("change",this.options.productQtySelector,function(){t.processApplyChanges()})},setOptionValueTitle:function(t){var e=this.getFormElement(),n=a(".product-custom-option",e),i=this,o=i.options,r=o.optionConfig,s=o.localePriceFormat.priceSymbol;c.isUndefined(t)||(r=t),this._updateSelectOptions(n.filter("select"),r,s),this._updateInputOptions(n.filter("input"),r,s)},_updateSelectOptions:function(t,e,n){var i=this;t.each(function(o,r){var s=a(r);if(s.hasClass("datetime-picker")||s.hasClass("text-input")||s.hasClass("input-text")||s.attr("type")=="file")return!0;var d=u.findOptionId(s),p=e[d];s.find("option").each(function(l,m){var h=a(m),g=h.val();if(!(!g&&g!==0)){var y=p[g];i.getOptionText(h,y,n)}})})},_updateInputOptions:function(t,e,n){var i=this;t.each(function(o,r){var s=a(r);if(s.hasClass("datetime-picker")||s.hasClass("text-input")||s.hasClass("input-text")||s.attr("type")=="file")return!0;var d=u.findOptionId(s),p=s.val();if(!(!p&&p!==0)){var l=e[d],m=l[p];i.getOptionText(s.next("label"),m,n)}})},getOptionText:function(t,e,n){var i=e&&e.name,o=u.formatPrice(e.prices.finalPrice.amount),r="",s="";e&&(c.isEmpty(e.special_price_display_node)||(s=e.special_price_display_node),c.isEmpty(e.stockMessage)||(r=e.stockMessage),c.isEmpty(e.title)||(i=e.title),e.prices.basePrice.amount&&(e.prices.finalPrice.amount&&e.prices.finalPrice.amount>e.prices.basePrice.amount?o=e.prices.finalPrice.amount:o=e.prices.basePrice.amount)),s?t.text(i+" "+s+" "+r):r&&(parseFloat(e.prices.finalPrice.amount)>0?t.text(i+" +"+n+o+" "+r):t.text(i+r))},_setOptions:function(t){return a.extend(!0,this.options,t),this._super(t)},getFormElement:function(){var t;if(this.options.systemConfig.area==="adminhtml"?t=a("#product_composite_configure_form"):this.element.is("form")?t=this.element:t=this.element.closest("form"),t.length===0)throw"Invalid or empty form element";return t},optionChanged:function(t){var e=a(t.target);e.data("optionContainer",e.closest(this.options.controlContainer)),a.each(this.updaters,function(n,i){var o=i.update;o&&o instanceof Function&&o.apply(i,[e,this.options.optionConfig,this.options.productConfig,this])}.bind(this)),this.processApplyChanges()},processApplyChanges:function(){a.each(this.updaters,function(t,e){var n=e.applyChanges;n&&n instanceof Function&&n.apply(e,[this,this.options.productConfig])}.bind(this))},setProductFinalPrice:function(t){var e=this.options,n=e.priceFormat,i=e.priceTemplate,o=a(e.productPriceInfoSelector).find('[data-price-type="finalPrice"]'),r={};c.isUndefined(o)||(t<0&&(t=0),i=f(i),r.data={value:t,formatted:u.formatPrice(t,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setAdditionalProductFinalPrice:function(t){var e=this.options,n=e.priceFormat,i=e.priceTemplate,o=a(e.mageworxAdditionalPriceInfoSelector).find('[data-price-type="finalPrice"]'),r={};c.isUndefined(o)||(t<0&&(t=0),i=f(i),r.data={value:t,formatted:u.formatPrice(t,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setProductPriceExclTax:function(t){var e=this.options,n=e.priceFormat,i=e.priceTemplate,o=a(e.productPriceInfoSelector).find('[data-price-type="basePrice"]'),r={};c.isUndefined(o)||(t<0&&(t=0),i=f(i),r.data={value:t,formatted:u.formatPrice(t,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setAdditionalProductPriceExclTax:function(t){var e=this.options,n=e.priceFormat,i=e.priceTemplate,o=a(e.mageworxAdditionalPriceInfoSelector).find('[data-price-type="basePrice"]'),r={};c.isUndefined(o)||(t<0&&(t=0),i=f(i),r.data={value:t,formatted:u.formatPrice(t,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setProductRegularPrice:function(t){var e=this.options,n=e.priceFormat,i=e.priceTemplate,o=a(e.productPriceInfoSelector).find('[data-price-type="oldPrice"]'),r={};c.isUndefined(o)||(t<0&&(t=0),i=f(i),r.data={value:t,formatted:u.formatPrice(t,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setAdditionalProductRegularPrice:function(t){var e=this.options,n=e.priceFormat,i=e.priceTemplate,o=a(e.mageworxAdditionalPriceInfoSelector).find('[data-price-type="oldPrice"]'),r={};c.isUndefined(o)||(t<0&&(t=0),i=f(i),r.data={value:t,formatted:u.formatPrice(t,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},isOneTimeOption:function(t){var e=this.options;return e.extendedOptionsConfig&&e.extendedOptionsConfig[t]&&e.extendedOptionsConfig[t].one_time&&e.extendedOptionsConfig[t].one_time!="0"},isNonSelectableOptionsUsed:function(){var t=this,e=this.getFormElement(),n=a(this.options.optionsSelector,e),i=!1;return n.filter('input[type="text"], textarea, input[type="file"]').each(function(o,r){var s=a(r),d=s.val();if(!c.isUndefined(d)&&d.length>0){i=!0;return}}),i},getPriceFromHtmlElement:function(t){var e=this.options.localePriceFormat,n=e.decimalSymbol,i=e.groupSymbol,o=e.pattern,r=e.priceSymbol,s=0,d=a(t).text(),p;return p=parseFloat(d.replace(new RegExp("''"+i,"g"),"").replace(new RegExp("''"+n,"g"),".").replace(/[^0-9\.,]/g,"")),p&&(s=p),s},getOptionHtmlById:function(t){var e=a(this.options.optionsSelector+'[name^="options['+t+']"]',this.getFormElement()).first().closest(".field[data-option_id]");return e.length==0&&(e=a(this.options.optionsSelector+'[name^="options_'+t+'_file"]',this.getFormElement()).first().closest(".field[data-option_id]")),e},isPriceWithTax:function(){return this.toBoolean(this.options.catalogPriceContainsTax)},getPriceDisplayMode:function(){return parseInt(this.options.priceDisplayMode)},toBoolean:function(t){return!(t==0||t=="0"||t==!1)},getOptionId:function(t){if(navigator.userAgent.indexOf("rv:11")==-1)var e=/(options\[){1}(\d+)+(\]){1}/,n=new RegExp(e.source,"g");else var n=new RegExp("/(options[){1}(d+)+(]){1}/","g");return n.test(t.attr("data-selector")),parseInt(RegExp.$2)},getDateDropdownConfig:function(t,e){var n=!0;return e.each(function(i,o){n=n&&!!a(o).val()}),n?t:{}},getApoData:function(){return c.isUndefined(window.apoData)&&(window.apoData={}),window.apoData},isAnyOptionSelected:function(){var t=!1,e=this;return a.each(e.getApoData(),function(n,i){!c.isUndefined(i)&&i.length>0&&(t=!0)}),t},getNewlyShowedOptionValues:function(){return c.isArray(window.newlyShowedOptionValues)!==!0&&(window.newlyShowedOptionValues=[]),window.newlyShowedOptionValues},addNewlyShowedOptionValue:function(t){c.isArray(window.newlyShowedOptionValues)!==!0&&(window.newlyShowedOptionValues=[]);var e=window.newlyShowedOptionValues.indexOf(t);e===-1&&window.newlyShowedOptionValues.push(t)},removeNewlyShowedOptionValue:function(t){c.isArray(window.newlyShowedOptionValues)!==!0&&(window.newlyShowedOptionValues=[]);var e=window.newlyShowedOptionValues.indexOf(t);e!==-1&&window.newlyShowedOptionValues.splice(e,1)},getSelectedData:function(){return c.isUndefined(window.apoSelectedData)&&(window.apoSelectedData={}),window.apoSelectedData},collectSelectedData:function(){window.apoSelectedData={};var t=this,e=this.getFormElement(),n=this.options,i=a(n.optionsSelector,e);i.filter("select").each(function(o,r){var s=a(r),d=u.findOptionId(s),p=n.optionConfig&&n.optionConfig[d],l=s.val();c.isUndefined(l)||!l||(Array.isArray(l)||(l=[l]),a(l).each(function(m,h){if(c.isUndefined(p[h])){if(c.isUndefined(p.prices))return;var g=s.parent().find(n.dateDropdownsSelector);if(!c.isUndefined(g))return;if(s.closest(".field").css("display")=="none"){s.val("");return}}Array.isArray(window.apoSelectedData[d])||(window.apoSelectedData[d]=[]),window.apoSelectedData[d].push(h)}))}),i.filter('input[type="radio"], input[type="checkbox"]').each(function(o,r){var s=a(r),d=u.findOptionId(s),p=n.optionConfig&&n.optionConfig[d],l=s.val();!s.is(":checked")||c.isUndefined(l)||!l||(Array.isArray(window.apoSelectedData[d])||(window.apoSelectedData[d]=[]),window.apoSelectedData[d].push(l))})}}),a.mageworx.optionBase});
