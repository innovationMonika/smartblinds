define(["jquery","Magento_Catalog/js/price-utils","uiRegistry","underscore","mage/template","jquery-ui-modules/widget"],function(a,u,w,p,f){"use strict";return a.widget("mageworx.optionBase",{options:{optionConfig:{},systemConfig:{},productConfig:{},productQtySelector:"#qty",productPriceInfoSelector:".product-info-price",mageworxAdditionalPriceInfoSelector:".mageworx-product-final-price",extendedOptionsConfig:{},priceHolderSelector:".price-box",dateDropdownsSelector:"[data-role=calendar-dropdown]",optionsSelector:".product-custom-option",optionHandlers:{},optionTemplate:"<%= data.label %><% if (data.finalPrice.value) { %> +<%- data.finalPrice.formatted %><% } %>",controlContainer:"dd",priceTemplate:'<span class="price"><%- data.formatted %></span>',localePriceFormat:{},productFinalPriceExclTax:0,productRegularPriceExclTax:0,productFinalPriceInclTax:0,productRegularPriceInclTax:0,configUrl:"",priceDisplayMode:0,catalogPriceContainsTax:!1,configurableContainerSelector:"[data-role=swatch-options]",configurableSelector:".swatch-option"},updaters:{},_init:function(){var e=this;p.each(this.updaters,function(t,n){try{e.triggerAfterInitPrice(e.getUpdater(n))}catch(i){console.log("Error:"),console.log(i)}}),this.processApplyChanges()},onUpdatePrice:function(e,t){return this.updatePrice(t)},_create:function(){var e=this;a(document).ready(function(){w.set("mageworxOptionBase",e);var t=w.get("mageworxOptionUpdaters");t||(t={});var n=Object.keys(t).sort(function(i,o){return i-o});a.each(n,function(i,o){!t.hasOwnProperty(o)||e.addUpdater(o,t[o])}),e.addOptionChangeListeners(),a("#product-options-wrapper").show()})},addUpdater:function(e,t){var n,i=this;try{n=this.getUpdater(e)}catch{n=null}if(n){if(n.options=t.options,i.options.productId!=window.productId&&!i.options.isInUpdateProcess)i.getBaseConfig().then(function(o){try{i.runUpdater(n)}catch(r){console.log("Error:"),console.log(r)}}).catch(function(o){console.log(o)});else if(i.options.productId==window.productId)try{i.runUpdater(n)}catch(o){console.log("Error:"),console.log(o)}}else{this.updaters[e]=t;try{n=this.getUpdater(e),this.runUpdater(n)}catch(o){console.log("Error:"),console.log(o)}}},getBaseConfig:function(){var e=this;return e.options.isInUpdateProcess=!0,new Promise(function(t,n){a.ajax({url:e.options.configUrl,data:{productId:window.productId},success:function(i){a.each(i,function(o,r){e.options[o]=JSON.parse(r)}),e.options.isInUpdateProcess=!1,t(i)},error:function(i){e.options.isInUpdateProcess=!1,n(i)}})})},getUpdater:function(e){if(p.isUndefined(this.updaters[e]))throw"Undefined updater with name: "+e;return this.updaters[e]},runUpdater:function(e){var t=e.firstRun;typeof t!="undefined"&&t&&t instanceof Function&&t.apply(e,[this.options.optionConfig,this.options.productConfig,this,e])},triggerAfterInitPrice:function(e){var t=e.afterInitPrice;typeof t!="undefined"&&t&&t instanceof Function&&t.apply(e,[this.options.optionConfig,this.options.productConfig,this,e])},addOptionChangeListeners:function(){var e=this;a(this.options.optionsSelector,this.getFormElement()).on("change",this.optionChanged.bind(this));var t=a(this.options.configurableContainerSelector);t.on("click",this.options.configurableSelector,function(){(e.isAnyOptionSelected()||e.isNonSelectableOptionsUsed())&&e.processApplyChanges()}),a("body").on("change",this.options.productQtySelector,function(){e.processApplyChanges()})},setOptionValueTitle:function(e){var t=this.getFormElement(),n=a(".product-custom-option",t),i=this,o=i.options,r=o.optionConfig,s=o.localePriceFormat.priceSymbol;p.isUndefined(e)||(r=e),this._updateSelectOptions(n.filter("select"),r,s),this._updateInputOptions(n.filter("input"),r,s)},_updateSelectOptions:function(e,t,n){var i=this;e.each(function(o,r){var s=a(r);if(s.hasClass("datetime-picker")||s.hasClass("text-input")||s.hasClass("input-text")||s.attr("type")=="file")return!0;var c=u.findOptionId(s),d=t[c];s.find("option").each(function(l,m){var h=a(m),g=h.val();if(!(!g&&g!==0)){var y=d[g];i.getOptionText(h,y,n)}})})},_updateInputOptions:function(e,t,n){var i=this;e.each(function(o,r){var s=a(r);if(s.hasClass("datetime-picker")||s.hasClass("text-input")||s.hasClass("input-text")||s.attr("type")=="file")return!0;var c=u.findOptionId(s),d=s.val();if(!(!d&&d!==0)){var l=t[c],m=l[d];i.getOptionText(s.next("label"),m,n)}})},getOptionText:function(e,t,n){var i=t&&t.name,o=u.formatPrice(t.prices.finalPrice.amount),r="",s="";t&&(p.isEmpty(t.special_price_display_node)||(s=t.special_price_display_node),p.isEmpty(t.stockMessage)||(r=t.stockMessage),p.isEmpty(t.title)||(i=t.title),t.prices.basePrice.amount&&(t.prices.finalPrice.amount&&t.prices.finalPrice.amount>t.prices.basePrice.amount?o=t.prices.finalPrice.amount:o=t.prices.basePrice.amount)),s?e.text(i+" "+s+" "+r):r&&(parseFloat(t.prices.finalPrice.amount)>0?e.text(i+" +"+n+o+" "+r):e.text(i+r))},_setOptions:function(e){return a.extend(!0,this.options,e),this._super(e)},getFormElement:function(){var e;if(this.options.systemConfig.area==="adminhtml"?e=a("#product_composite_configure_form"):this.element.is("form")?e=this.element:e=this.element.closest("form"),e.length===0)throw"Invalid or empty form element";return e},optionChanged:function(e){var t=a(e.target);t.data("optionContainer",t.closest(this.options.controlContainer)),a.each(this.updaters,function(n,i){var o=i.update;o&&o instanceof Function&&o.apply(i,[t,this.options.optionConfig,this.options.productConfig,this])}.bind(this)),this.processApplyChanges()},processApplyChanges:function(){a.each(this.updaters,function(e,t){var n=t.applyChanges;n&&n instanceof Function&&n.apply(t,[this,this.options.productConfig])}.bind(this))},setProductFinalPrice:function(e){var t=this.options,n=t.priceFormat,i=t.priceTemplate,o=a(t.productPriceInfoSelector).find('[data-price-type="finalPrice"]'),r={};p.isUndefined(o)||(e<0&&(e=0),i=f(i),r.data={value:e,formatted:u.formatPrice(e,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setAdditionalProductFinalPrice:function(e){var t=this.options,n=t.priceFormat,i=t.priceTemplate,o=a(t.mageworxAdditionalPriceInfoSelector).find('[data-price-type="finalPrice"]'),r={};p.isUndefined(o)||(e<0&&(e=0),i=f(i),r.data={value:e,formatted:u.formatPrice(e,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setProductPriceExclTax:function(e){var t=this.options,n=t.priceFormat,i=t.priceTemplate,o=a(t.productPriceInfoSelector).find('[data-price-type="basePrice"]'),r={};p.isUndefined(o)||(e<0&&(e=0),i=f(i),r.data={value:e,formatted:u.formatPrice(e,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setAdditionalProductPriceExclTax:function(e){var t=this.options,n=t.priceFormat,i=t.priceTemplate,o=a(t.mageworxAdditionalPriceInfoSelector).find('[data-price-type="basePrice"]'),r={};p.isUndefined(o)||(e<0&&(e=0),i=f(i),r.data={value:e,formatted:u.formatPrice(e,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setProductRegularPrice:function(e){var t=this.options,n=t.priceFormat,i=t.priceTemplate,o=a(t.productPriceInfoSelector).find('[data-price-type="oldPrice"]'),r={};p.isUndefined(o)||(e<0&&(e=0),i=f(i),r.data={value:e,formatted:u.formatPrice(e,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},setAdditionalProductRegularPrice:function(e){var t=this.options,n=t.priceFormat,i=t.priceTemplate,o=a(t.mageworxAdditionalPriceInfoSelector).find('[data-price-type="oldPrice"]'),r={};p.isUndefined(o)||(e<0&&(e=0),i=f(i),r.data={value:e,formatted:u.formatPrice(e,n)},o.hide(),setTimeout(function(){o.html(i(r)),o.fadeIn(500)},110))},isOneTimeOption:function(e){var t=this.options;return t.extendedOptionsConfig&&t.extendedOptionsConfig[e]&&t.extendedOptionsConfig[e].one_time&&t.extendedOptionsConfig[e].one_time!="0"},isNonSelectableOptionsUsed:function(){var e=this,t=this.getFormElement(),n=a(this.options.optionsSelector,t),i=!1;return n.filter('input[type="text"], textarea, input[type="file"]').each(function(o,r){var s=a(r),c=s.val();if(!p.isUndefined(c)&&c.length>0){i=!0;return}}),i},getPriceFromHtmlElement:function(e){var t=this.options.localePriceFormat,n=t.decimalSymbol,i=t.groupSymbol,o=t.pattern,r=t.priceSymbol,s=0,c=a(e).text(),d;return d=parseFloat(c.replace(new RegExp("''"+i,"g"),"").replace(new RegExp("''"+n,"g"),".").replace(/[^0-9\.,]/g,"")),d&&(s=d),s},getOptionHtmlById:function(e){var t=a(this.options.optionsSelector+'[name^="options['+e+']"]',this.getFormElement()).first().closest(".field[data-option_id]");return t.length==0&&(t=a(this.options.optionsSelector+'[name^="options_'+e+'_file"]',this.getFormElement()).first().closest(".field[data-option_id]")),t},isPriceWithTax:function(){return this.toBoolean(this.options.catalogPriceContainsTax)},getPriceDisplayMode:function(){return parseInt(this.options.priceDisplayMode)},toBoolean:function(e){return!(e==0||e=="0"||e==!1)},getOptionId:function(e){if(navigator.userAgent.indexOf("rv:11")==-1)var t=/(options\[){1}(\d+)+(\]){1}/,n=new RegExp(t.source,"g");else var n=new RegExp("/(options[){1}(d+)+(]){1}/","g");return n.test(e.attr("data-selector")),parseInt(RegExp.$2)},getDateDropdownConfig:function(e,t){var n=!0;return t.each(function(i,o){n=n&&!!a(o).val()}),n?e:{}},getApoData:function(){return p.isUndefined(window.apoData)&&(window.apoData={}),window.apoData},isAnyOptionSelected:function(){var e=!1,t=this;return a.each(t.getApoData(),function(n,i){!p.isUndefined(i)&&i.length>0&&(e=!0)}),e},getNewlyShowedOptionValues:function(){return p.isArray(window.newlyShowedOptionValues)!==!0&&(window.newlyShowedOptionValues=[]),window.newlyShowedOptionValues},addNewlyShowedOptionValue:function(e){p.isArray(window.newlyShowedOptionValues)!==!0&&(window.newlyShowedOptionValues=[]);var t=window.newlyShowedOptionValues.indexOf(e);t===-1&&window.newlyShowedOptionValues.push(e)},removeNewlyShowedOptionValue:function(e){p.isArray(window.newlyShowedOptionValues)!==!0&&(window.newlyShowedOptionValues=[]);var t=window.newlyShowedOptionValues.indexOf(e);t!==-1&&window.newlyShowedOptionValues.splice(t,1)},getSelectedData:function(){return p.isUndefined(window.apoSelectedData)&&(window.apoSelectedData={}),window.apoSelectedData},collectSelectedData:function(){window.apoSelectedData={};var e=this,t=this.getFormElement(),n=this.options,i=a(n.optionsSelector,t);i.filter("select").each(function(o,r){var s=a(r),c=u.findOptionId(s),d=n.optionConfig&&n.optionConfig[c],l=s.val();p.isUndefined(l)||!l||(Array.isArray(l)||(l=[l]),a(l).each(function(m,h){if(p.isUndefined(d[h])){if(p.isUndefined(d.prices))return;var g=s.parent().find(n.dateDropdownsSelector);if(!p.isUndefined(g))return;if(s.closest(".field").css("display")=="none"){s.val("");return}}Array.isArray(window.apoSelectedData[c])||(window.apoSelectedData[c]=[]),window.apoSelectedData[c].push(h)}))}),i.filter('input[type="radio"], input[type="checkbox"]').each(function(o,r){var s=a(r),c=u.findOptionId(s),d=n.optionConfig&&n.optionConfig[c],l=s.val();!s.is(":checked")||p.isUndefined(l)||!l||(Array.isArray(window.apoSelectedData[c])||(window.apoSelectedData[c]=[]),window.apoSelectedData[c].push(l))})}}),a.mageworx.optionBase});
