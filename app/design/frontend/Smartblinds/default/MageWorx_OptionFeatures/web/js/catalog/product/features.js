define(["jquery","Magento_Catalog/js/price-utils","underscore","Magento_Catalog/js/price-box","qTip","jquery-ui-modules/widget"],function(l,I,p){"use strict";return l.widget("mageworx.optionFeatures",{options:{absolutePriceOptionTemplate:"<%= data.label %><% if (data.finalPrice.value) { %> <%- data.finalPrice.formatted %><% } %>"},firstRun:function(t,i,o,e){l("#mageworx_shareable_hint_icon").qtip({content:{text:this.options.shareable_link_hint_text},style:{classes:"qtip-light"},position:{target:!1}}),l("#mageworx_shareable_link").on("click",function(){try{e.copyTextToClipboard(e.getShareableLink(o)),l(".mageworx-shareable-link-container").hide(),l(".mageworx-shareable-link-success-container").show(),setTimeout(function(){l(".mageworx-shareable-link-container").show(),l(".mageworx-shareable-link-success-container").hide()},2e3)}catch{console.log("Something goes wrong. Unable to copy")}}),setTimeout(function(){l(".mageworx-option-qty").each(function(){l(this).on("change",function(){var n=l("[data-selector='"+l(this).attr("data-parent-selector")+"']");n.trigger("change")})})},500);var c=typeof o.options.extendedOptionsConfig!="undefined"?o.options.extendedOptionsConfig:{};for(var s in t)if(t.hasOwnProperty(s)){var P=c[s].description,r=o.getOptionHtmlById(s);if(1>r.length){console.log("Empty option container for option with id: "+s);continue}if(this.options.option_description_enabled&&!p.isEmpty(c[s].description))if(this.options.option_description_mode==this.options.option_description_modes.tooltip){var a=r.find("label span").first();a.length==0&&(a=r.find("fieldset legend span").first()),a.css("border-bottom","1px dotted black"),a.qtip({content:{text:P},style:{classes:"qtip-light"},position:{target:!1}})}else if(this.options.option_description_mode==this.options.option_description_modes.text){var d=r.find(".control");d.length&&d.first().after(l('<div class="option-description-text">'+P+"</div>"))}else console.log("Unknown option mode");this._addValueDescription(r,t,c,this.options.value_description_enabled)}},update:function(t,i,o,e){var c=l(t),s=l("[data-parent-selector='"+c.attr("data-selector")+"']"),P=1,r=c.val(),a=e.getOptionId(c);s.length&&(c.is(":checked")||l("option:selected",c).val()?(s.val()==0&&s.val(1),s.attr("disabled",!1),c.attr("type")=="radio"&&!c.hasClass("required")&&c.context.id=="options_"+a&&(s.val(0),s.attr("disabled",!0))):!c.is(":checked")&&!l("option:selected",c).val()&&s.attr("type")!="hidden"&&c.attr("type")!="radio"&&(s.val(0),s.attr("disabled",!0)),parseFloat(s.val())&&(P=parseFloat(s.val())),r&&(Array.isArray(r)||(r=[r]),l(r).each(function(d,n){i[a][n].qty=P})))},applyChanges:function(t,i){this.base=t;var o=!0;(p.isUndefined(i.absolute_price)||i.absolute_price=="0")&&(o=!1),!(i.type_id=="configurable"&&!o)&&(this.initProductPrice(i),this.calculateSelectedOptionsPrice(),this.applyProductPriceDisplayMode(),!o||o&&this.optionBasePrice<=0?(this.productDefaultRegularPriceExclTax+=parseFloat(this.optionOldPricePerItemExclTax),this.productDefaultFinalPriceExclTax+=parseFloat(this.optionBasePricePerItem),this.productDefaultRegularPriceInclTax+=parseFloat(this.optionOldPricePerItemInclTax),this.productDefaultFinalPriceInclTax+=parseFloat(this.optionFinalPricePerItem),this.productPerItemRegularPriceExclTax+=parseFloat(this.optionOldPricePerItemExclTax),this.productPerItemFinalPriceExclTax+=parseFloat(this.optionBasePricePerItem),this.productPerItemRegularPriceInclTax+=parseFloat(this.optionOldPricePerItemInclTax),this.productPerItemFinalPriceInclTax+=parseFloat(this.optionFinalPricePerItem),this.productTotalRegularPriceExclTax+=parseFloat(this.optionOldPriceExclTax),this.productTotalFinalPriceExclTax+=parseFloat(this.optionBasePrice),this.productTotalRegularPriceInclTax+=parseFloat(this.optionOldPriceInclTax),this.productTotalFinalPriceInclTax+=parseFloat(this.optionFinalPrice)):(this.productDefaultRegularPriceExclTax=parseFloat(this.optionOldPricePerItemExclTax),this.productDefaultFinalPriceExclTax=parseFloat(this.optionBasePricePerItem),this.productDefaultRegularPriceInclTax=parseFloat(this.optionOldPricePerItemInclTax),this.productDefaultFinalPriceInclTax=parseFloat(this.optionFinalPricePerItem),this.productPerItemRegularPriceExclTax=parseFloat(this.optionOldPricePerItemExclTax),this.productPerItemFinalPriceExclTax=parseFloat(this.optionBasePricePerItem),this.productPerItemRegularPriceInclTax=parseFloat(this.optionOldPricePerItemInclTax),this.productPerItemFinalPriceInclTax=parseFloat(this.optionFinalPricePerItem),this.productTotalRegularPriceExclTax=parseFloat(this.optionOldPriceExclTax),this.productTotalFinalPriceExclTax=parseFloat(this.optionBasePrice),this.productTotalRegularPriceInclTax=parseFloat(this.optionOldPriceInclTax),this.productTotalFinalPriceInclTax=parseFloat(this.optionFinalPrice)),t.getPriceDisplayMode()==1?(this.options.product_price_display_mode==="per_item"?(t.setProductRegularPrice(this.productPerItemRegularPriceExclTax),t.setProductFinalPrice(this.productPerItemFinalPriceExclTax)):this.options.product_price_display_mode==="final_price"?(t.setProductRegularPrice(this.productTotalRegularPriceExclTax),t.setProductFinalPrice(this.productTotalFinalPriceExclTax)):this.options.product_price_display_mode==="disabled"&&(t.setProductRegularPrice(this.productDefaultRegularPriceExclTax),t.setProductFinalPrice(this.productDefaultFinalPriceExclTax)),this.options.additional_product_price_display_mode==="per_item"?(t.setAdditionalProductRegularPrice(this.productPerItemRegularPriceExclTax),t.setAdditionalProductFinalPrice(this.productPerItemFinalPriceExclTax)):this.options.additional_product_price_display_mode==="final_price"?(t.setAdditionalProductRegularPrice(this.productTotalRegularPriceExclTax),t.setAdditionalProductFinalPrice(this.productTotalFinalPriceExclTax)):this.options.additional_product_price_display_mode==="disabled"&&(t.setAdditionalProductRegularPrice(this.productDefaultRegularPriceExclTax),t.setAdditionalProductFinalPrice(this.productDefaultFinalPriceExclTax))):(this.options.product_price_display_mode==="per_item"?(t.setProductRegularPrice(this.productPerItemRegularPriceInclTax),t.setProductFinalPrice(this.productPerItemFinalPriceInclTax)):this.options.product_price_display_mode==="final_price"?(t.setProductRegularPrice(this.productTotalRegularPriceInclTax),t.setProductFinalPrice(this.productTotalFinalPriceInclTax)):this.options.product_price_display_mode==="disabled"&&(t.setProductRegularPrice(this.productDefaultRegularPriceInclTax),t.setProductFinalPrice(this.productDefaultFinalPriceInclTax)),this.options.additional_product_price_display_mode==="per_item"?(t.setAdditionalProductRegularPrice(this.productPerItemRegularPriceInclTax),t.setAdditionalProductFinalPrice(this.productPerItemFinalPriceInclTax)):this.options.additional_product_price_display_mode==="final_price"?(t.setAdditionalProductRegularPrice(this.productTotalRegularPriceInclTax),t.setAdditionalProductFinalPrice(this.productTotalFinalPriceInclTax)):(t.setAdditionalProductRegularPrice(this.productDefaultRegularPriceInclTax),t.setAdditionalProductFinalPrice(this.productDefaultFinalPriceInclTax))),this.options.product_price_display_mode==="per_item"?t.setProductPriceExclTax(this.productPerItemFinalPriceExclTax):this.options.product_price_display_mode==="final_price"?t.setProductPriceExclTax(this.productTotalFinalPriceExclTax):this.options.product_price_display_mode==="disabled"&&t.setProductPriceExclTax(this.productDefaultFinalPriceExclTax),this.options.additional_product_price_display_mode==="per_item"?t.setAdditionalProductPriceExclTax(this.productPerItemFinalPriceExclTax):this.options.additional_product_price_display_mode==="final_price"?t.setAdditionalProductPriceExclTax(this.productTotalFinalPriceExclTax):t.setAdditionalProductPriceExclTax(this.productDefaultFinalPriceExclTax))},calculateSelectedOptionsPrice:function(){var t=this,i=this.base.getFormElement(),o=this.base.options,e=l(o.optionsSelector,i),c=[];this.optionFinalPrice=0,this.optionBasePrice=0,this.optionOldPriceInclTax=0,this.optionOldPriceExclTax=0,this.optionFinalPricePerItem=0,this.optionBasePricePerItem=0,this.optionOldPricePerItemInclTax=0,this.optionOldPricePerItemExclTax=0,e.filter("select").each(function(s,P){var r=l(P),a=I.findOptionId(r),d=o.optionConfig&&o.optionConfig[a],n=r.val();p.isUndefined(n)||!n||(Array.isArray(n)||(n=[n]),l(n).each(function(f,u){if(p.isUndefined(d[u])){if(p.isUndefined(d.prices))return;var _=r.parent().find(o.dateDropdownsSelector);if(p.isUndefined(_))return;if(r.closest(".field").css("display")=="none"){r.val("");return}var x=t.base.getDateDropdownConfig(d,_);if(p.isUndefined(x.prices)||l.inArray(a,c)!=-1)return;c.push(a)}else var x=d[u];t.processOptionQtyInput(a,r,x),window.jsonATCCustomWidgetConfig.product_type!=="simple"&&t.collectOptionPriceAndQty(x,a,u)}))}),e.filter('input[type="radio"], input[type="checkbox"]').each(function(s,P){var r=l(P),a=I.findOptionId(r),d=o.optionConfig&&o.optionConfig[a],n=r.val();if(!!r.is(":checked")&&!(typeof n=="undefined"||!n)){var f=d[n];t.processOptionQtyInput(a,r,f),t.collectOptionPriceAndQty(f,a,n)}}),e.filter('input[type="text"], textarea, input[type="file"]').each(function(s,P){var r=l(P),a=I.findOptionId(r),d=o.optionConfig&&o.optionConfig[a],n=r.val();if(!((typeof n=="undefined"||!n)&&l("#delete-options_"+a+"_file").length<1)){if(r.closest(".field").css("display")=="none"){r.val("");return}var f=t.base.isOneTimeOption(a),u=1;f||(u=l(o.productQtySelector).val());var _=!1,x=t.getProductActualTierPrice();if(x!==null&&!p.isUndefined(o.extendedOptionsConfig[a].price)&&!p.isUndefined(o.extendedOptionsConfig[a].price_type)&&o.extendedOptionsConfig[a].price_type==="percent"){_=!0;var h=o.extendedOptionsConfig[a].price*x/100,m=o.extendedOptionsConfig[a].price*t.getProductActualTierPrice(!0)/100}var T=r.closest("#product_addtocart_form"),g=r.data("role"),y=T.data("mage-priceOptions").options.optionHandlers[g],v={};if(y){var b={};b[a]=d,v=y(r,b)}var R=v.hasOwnProperty(r.data("role"))?v[r.data("role")]:null,F=R||d.prices,E=F.basePrice.amount,O=F.finalPrice.amount;_&&(E=h,O=m),t.optionFinalPrice+=parseFloat(O)*u,t.optionOldPriceInclTax+=parseFloat(F.oldPrice.amount_incl_tax)*u,t.optionBasePrice+=parseFloat(E)*u,t.optionOldPriceExclTax+=parseFloat(F.oldPrice.amount_excl_tax)*u,t.optionFinalPricePerItem+=parseFloat(O),t.optionOldPricePerItemInclTax+=parseFloat(F.oldPrice.amount_incl_tax),t.optionBasePricePerItem+=parseFloat(E),t.optionOldPricePerItemExclTax+=parseFloat(F.oldPrice.amount_excl_tax)}})},processOptionQtyInput:function(t,i,o){var e=l("[data-parent-selector='"+i.attr("data-selector")+"']"),c=1;e.length<1||(i.is(":checked")||l("option:selected",i).val()?(e.val()===0&&e.val(1),e.attr("disabled",!1)):!i.is(":checked")&&!l("option:selected",i).val()&&e.attr("type")!=="hidden"&&$option.attr("type")!=="radio"&&(e.val(0),e.attr("disabled",!0)),parseFloat(e.val())&&(c=parseFloat(e.val())),o.qty=c)},collectOptionPriceAndQty:function(t,i,o){this.actualPriceInclTax=0,this.actualPriceExclTax=0;var e=this.base.options,c=this.base.isOneTimeOption(i),s=l(e.productQtySelector).val(),P=p.isUndefined(t.qty)?1:t.qty;this.getActualPrice(i,o,P),s==0&&(s=1);var r=this.actualPriceInclTax?this.actualPriceInclTax:parseFloat(t.prices.finalPrice.amount),a=this.actualPriceExclTax?this.actualPriceExclTax:parseFloat(t.prices.basePrice.amount),d=parseFloat(t.prices.oldPrice.amount_incl_tax),n=parseFloat(t.prices.oldPrice.amount_excl_tax),f=this.actualPriceInclTax?this.actualPriceInclTax:parseFloat(t.prices.finalPrice.amount),u=this.actualPriceExclTax?this.actualPriceExclTax:parseFloat(t.prices.basePrice.amount),_=parseFloat(t.prices.oldPrice.amount_incl_tax),x=parseFloat(t.prices.oldPrice.amount_excl_tax);!c&&(this.options.product_price_display_mode==="final_price"||this.options.additional_product_price_display_mode==="final_price")&&(r*=s,a*=s,d*=s,n*=s),this.optionFinalPricePerItem+=f*P,this.optionBasePricePerItem+=u*P,this.optionOldPricePerItemInclTax+=_*P,this.optionOldPricePerItemExclTax+=x*P,this.optionFinalPrice+=r*P,this.optionBasePrice+=a*P,this.optionOldPriceInclTax+=d*P,this.optionOldPriceExclTax+=n*P},getActualPrice:function(t,i,o){var e=this.base.options,c=null,s=null,P=null,r=0,a=0,d=null,n=null,f=this.base.isOneTimeOption(t),u=l(e.productQtySelector).val(),_=!1;if(!p.isUndefined(e.extendedOptionsConfig[t].values)){if(f?r=parseFloat(o):r=parseFloat(u)*parseFloat(o),!p.isUndefined(e.optionConfig[t][i].prices.basePrice.amount)){c=e.optionConfig[t][i].prices.basePrice.amount;var x=this.getProductActualTierPrice();if(x!==null&&!p.isUndefined(e.extendedOptionsConfig[t].values[i].price)&&!p.isUndefined(e.extendedOptionsConfig[t].values[i].price_type)&&e.extendedOptionsConfig[t].values[i].price_type==="percent"&&c>e.extendedOptionsConfig[t].values[i].price*x/100){_=!0;var h=e.extendedOptionsConfig[t].values[i].price*x/100,m=e.extendedOptionsConfig[t].values[i].price*this.getProductActualTierPrice(!0)/100}}p.isUndefined(e.extendedOptionsConfig[t].values[i].tier_price)||(s=l.parseJSON(e.extendedOptionsConfig[t].values[i].tier_price),p.isUndefined(s[r])?l.each(s,function(T,g){a=parseFloat(T),n<a&&r>=a&&(d=g,n=a)}):(d=s[r],n=r)),d&&(d.price<c||c===null)?(this.actualPriceExclTax=d.price,this.actualPriceInclTax=d.price_incl_tax):_?(this.actualPriceExclTax=h,this.actualPriceInclTax=m):(this.actualPriceExclTax=c,this.actualPriceInclTax=e.optionConfig[t][i].prices.finalPrice.amount)}},initProductPrice:function(t){this.productDefaultRegularPriceExclTax=t.regular_price_excl_tax,this.productDefaultRegularPriceInclTax=t.regular_price_incl_tax,this.productDefaultFinalPriceExclTax=t.final_price_excl_tax,this.productDefaultFinalPriceInclTax=t.final_price_incl_tax,this.productPerItemRegularPriceExclTax=t.regular_price_excl_tax,this.productPerItemRegularPriceInclTax=t.regular_price_incl_tax,this.productPerItemFinalPriceExclTax=t.final_price_excl_tax,this.productPerItemFinalPriceInclTax=t.final_price_incl_tax,this.productTotalRegularPriceExclTax=t.regular_price_excl_tax,this.productTotalRegularPriceInclTax=t.regular_price_incl_tax,this.productTotalFinalPriceExclTax=t.final_price_excl_tax,this.productTotalFinalPriceInclTax=t.final_price_incl_tax},applyProductPriceDisplayMode:function(){var t=this.options.product_price_display_mode,i=this.options.additional_product_price_display_mode,o=parseFloat(l(this.base.options.productQtySelector).val()),e=null;(t==="per_item"||i==="per_item"||t==="final_price"||i==="final_price")&&(e=this.getProductActualTierPrice(),(t==="per_item"||i==="per_item")&&e!==null&&(this.productPerItemFinalPriceExclTax=e,this.productPerItemFinalPriceInclTax=this.getProductActualTierPrice(!0)),(t==="final_price"||i==="final_price")&&(e!==null?(this.productTotalFinalPriceExclTax=e*o,this.productTotalFinalPriceInclTax=this.getProductActualTierPrice(!0)*o):(this.productTotalFinalPriceExclTax=this.productDefaultFinalPriceExclTax*o,this.productTotalFinalPriceInclTax=this.productDefaultFinalPriceInclTax*o),this.productTotalRegularPriceExclTax=this.productDefaultRegularPriceExclTax*o,this.productTotalRegularPriceInclTax=this.productDefaultRegularPriceInclTax*o))},getProductActualTierPrice:function(t){var i=this.base.options,o=i.productConfig,e=null,c=l(i.productQtySelector).val(),s=t?"price_incl_tax":"price_excl_tax";if(p.isUndefined(o.extended_tier_prices)||o.extended_tier_prices.length<1)return e;var P=o.extended_tier_prices;return P.sort(function(r,a){return r.qty-a.qty}),p.each(P,function(r,a){parseFloat(r.qty)>parseFloat(c)||(e===null||parseFloat(r[s])<parseFloat(e))&&(e=r[s])}),e},_addValueDescription:function(t,i,o,e){var c=this,s=t.find(".product-custom-option");s.filter("select").each(function(P,r){var a=l(r),d=I.findOptionId(a),n=o[d].values;if(!(a.attr("multiple")&&!a.hasClass("mageworx-swatch"))&&!(typeof n=="undefined"||p.isEmpty(n))){if(a.hasClass("mageworx-swatch")){var f=a.parent().find(".mageworx-swatch-option");f.each(function(_,x){var h=l(x).attr("data-option-type-id"),m=c.getTooltipImageHtml(n[h]),T='<div class="title">'+n[h].title+"</div>",g="";if(p.isEmpty(i[d][h].stockMessage)||(g='<div class="info">'+i[d][h].stockMessage+"</div>"),e){if(!p.isUndefined(n[h])&&(!p.isEmpty(n[h].description)||!p.isEmpty(n[h].images_data.tooltip_image))){var y="";p.isEmpty(n[h].description)||(y=n[h].description),c.prepareTooltipDescription(l(x),m,T,g,y)}}else!p.isUndefined(n[h])&&!p.isEmpty(n[h].images_data.tooltip_image)&&c.prepareTooltipDescription(l(x),m,T,g)})}else{var u=l("<img>",{src:c.options.question_image,alt:"tooltip",class:"option-select-tooltip-"+d,width:"16px",height:"16px",style:"display: none"});a.parent().prepend(u),a.on("change",function(_){var x=a.val(),h=c.getTooltipImageHtml(n[x]);e?!p.isUndefined(n[x])&&(!p.isEmpty(n[x].description)||!p.isEmpty(n[x].images_data.tooltip_image))?(c.prepareTooltipDescription(u,h,"","",n[x].description),u.show()):u.hide():!p.isUndefined(n[x])&&!p.isEmpty(n[x].images_data.tooltip_image)?(c.prepareTooltipDescription(u,h),u.show()):u.hide()})}a.val()&&a.trigger("change")}}),s.filter('input[type="radio"], input[type="checkbox"]').each(function(P,r){var a=l(r),d=I.findOptionId(a),n=o[d],f=o[d].values;if(!(typeof f=="undefined"||!f)){var u=a.val(),_=f[u].description,x=c.getTooltipImageHtml(f[u]),h=c.getTooltipImageForOptionValue(u);e?!p.isUndefined(f[u])&&(!p.isEmpty(f[u].description)||!p.isEmpty(f[u].images_data.tooltip_image))&&(a.parent().append(h),c.prepareTooltipDescription(h,x,"","",_)):!p.isUndefined(f[u])&&!p.isEmpty(f[u].images_data.tooltip_image)&&(a.parent().append(h),c.prepareTooltipDescription(h,x))}})},prepareTooltipDescription:function(t,i="",o="",e="",c=""){t.qtip({content:{text:i+o+e+c},style:{classes:"qtip-light"},position:{target:!1}})},getTooltipImageForOptionValue:function(t){return l("<img>",{src:this.options.question_image,alt:"tooltip",class:"option-value-tooltip-"+t,width:"16px",height:"16px"})},getTooltipImageHtml:function(t){return typeof t!="undefined"&&t.images_data.tooltip_image?'<div class="image" style="width:auto; height:auto"><img src="'+t.images_data.tooltip_image+'" /></div>':""},copyTextToClipboard:function(t){var i=document.createElement("textarea");i.style.position="fixed",i.style.top=0,i.style.left=0,i.style.width="2em",i.style.height="2em",i.style.padding=0,i.style.border="none",i.style.outline="none",i.style.boxShadow="none",i.style.background="transparent",i.value=t,document.body.appendChild(i),i.focus(),i.select(),document.execCommand("copy"),document.body.removeChild(i)},getShareableLink:function(t){var i=window.location.origin+window.location.pathname,o=this.getSelectedOptionsString(t);return o&&(i+="?config=",i+=o),i+=window.location.hash,i},getSelectedOptionsString:function(t){var i="",o=this;t.collectSelectedData();var e=t.getSelectedData(),c=[];return l.each(e,function(s,P){c.push(s+"-"+P.join("-"))}),c.join(",")}}),l.mageworx.optionFeatures});
