define(["jquery","underscore","mage/translate","text!MageWorx_OptionFeatures/template/option/gallery/dropdown.html","text!MageWorx_OptionFeatures/template/option/gallery/radio.html","text!MageWorx_OptionFeatures/template/option/gallery/checkbox.html","text!MageWorx_OptionFeatures/template/option/gallery/empty.html","mwImageReplacer","jquery/validate","jquery-ui-modules/widget","jquery/jquery.parsequery"],function(o,a,_,O,y,v,I,u){"use strict";return o.widget("mageworx.optionAdditionalImages",{options:{productImageClassSelector:".fotorama__img",customOptionClassSelector:".product-custom-option",imagesContainerClass:"option_images_gallery",currentOptionId:null,images:[],$element:null,templates:{drop_down:O,radio:y,checkbox:v,multiple:O},image_replacement_candidates:{}},firstRun:function(e,i,n,t){var s=this.options;if(o(s.customOptionClassSelector).each(function(){var p=o(this);if(s.$element=p,!t.out()){var h='<div class="'+s.imagesContainerClass+'"/>';p.parent().append(h),(t.getOGType()==t.getOGTypeBesideOption()||t.getOGType()==t.getOGTypeOnceSelected())&&t.elementChange(),(t.getOptionType()=="drop_down"||t.getOptionType()=="multiple")&&t._observeStyleOptions()}}),this.isEnabledAnyOptionOverlayMode()){var r=o(".gallery-placeholder")[0],d=new MutationObserver(function(p){p.forEach(function(h){var c=h.addedNodes;if(c!==null){var l=o(c);l.each(function(){var m=o(this);m.hasClass("fotorama-item")&&setTimeout(function(){t.processOverlayImages(),d.disconnect()},500)})}})}),g={attributes:!0,childList:!0,characterData:!0};d.observe(r,g)}},update:function(e,i,n,t){this.options.$element=o(e),!this.out()&&this.elementChange()},out:function(){var e=this.resolveOptionId();this.options.currentOptionId=e;var i=this.getOptionType();return!e||!i||a.isUndefined(this.options.render_images_for_option_types)||this.options.render_images_for_option_types.indexOf(i)==-1},resolveOptionId:function(){var e=this.options.$element.attr("id");return e=e.replace("select_","").replace("options_",""),e.match(/_/)?e.split("_")[0]:e},_observeStyleOptions:function(){var e=this,i=this.options,n=i.$element.find("option"),t=new MutationObserver(function(s){s.forEach(function(r){i.$element=o(r.target).closest(".product-custom-option"),i.currentOptionId=e.resolveOptionId(),e.elementChange()})});o.each(n,function(s,r){t.observe(r,{attributes:!0,attributeFilter:["style"]})})},elementChange:function(){this.clearImagesContainer();var e=this,i=this.options.$element.val();if(this.getOGType()!=this.getOGTypeDisabled()&&!i&&this.isEnabledOptionReplaceMode()){var n=this.getOptionValueSortOrder(this.getOptionId(),null);this._removeCandidateForReplacement(n),u.forceRefresh()}this.isEnabledOptionReplaceMode()&&(this._removeUnselectedCandidates(this.getOptionId(),i),u.forceRefresh()),this._renderImages(i),this.isEnabledOptionReplaceMode()&&u.replace(),this.isEnabledOptionOverlayMode()&&e.processOverlayImages()},processOverlayImages:function(){var e=this;o(".mageworx-overlay-images-"+this.getOptionId()).remove(),a.isUndefined(window.apoData[this.getOptionId()])||o.each(window.apoData[this.getOptionId()],function(i,n){e.addOverlayImage(n)})},addOverlayImage:function(e){o(this.options.productImageClassSelector).parent().append('<img class="fotorama__img mageworx-overlay-images-'+this.getOptionId()+'" src="'+this.options.options[this.getOptionId()].values[e].overlay_image_url+'" style="position: absolute; z-index: '+e+';">')},_renderImages:function(e){var i=this._prepareOptionImages(e),n=this._resolveTemplateByOptionType(this.getOptionType());if(Object.keys(i).length>0){if(this.getOGType()==this.getOGTypeBesideOption()||this._isValueSelected()){this.getOptionType()=="radio"&&this.getOGType()!=this.getOGTypeBesideOption()&&this._clearRadioImagesContainer();var t=a.template(n)({images:i}),s=this.getOptionGalleryContainer();s.append(t)}}else if(this.isEnabledOptionReplaceMode()){var r=this.getOptionValueSortOrder(this.getOptionId(),null);this._removeCandidateForReplacement(r),u.forceRefresh()}},getOptionValueSortOrder:function(e,i){var n=this.options,t=n.options[e].sort_order*1e3;return i&&(n.$element.is('input[type="checkbox"]')||n.$element.is('select[multiple="multiple"]'))&&(t+=parseInt(n.options[e].values[i].sort_order)),t},_prepareOptionImages:function(e){var i=this,n={};if(a.isArray(e))a.each(e,function(s,r){a.extend(n,i._prepareImages(s))});else{var t=e;n=this._prepareImages(t)}return n},_prepareImages:function(e){var i={},n=this.getOptionId(),t=this.options;if(e&&!a.isUndefined(t.options[n])&&!a.isUndefined(t.options[n].values)&&!a.isUndefined(t.options[n].values[e])&&!a.isUndefined(t.options[n].values[e].images)&&(i=o.extend(!0,{},t.options[n].values[e].images)),!(typeof t.$element=="undefined"||!t.$element instanceof jQuery)){if(t.options[n].mageworx_option_image_mode!=0)for(var s in i){i[s].additional_class="mageworx-optionfeatures-option-gallery_image_selected";var r=this.getOptionValueSortOrder(n,e);i[s].replace_main_gallery_image=="1"&&(this.isElementSelected()?this._addCandidateForReplacement(i[s],r):this._removeCandidateForReplacement(r))}if((this.getOptionType()=="drop_down"||this.getOptionType()=="multiple")&&this.getOGType()==this.getOGTypeBesideOption()){var d=t.options[n].values;for(var g in d)if(!(g==e||a.isUndefined(d[g].images))){var p={},h=t.$element.parent().find(".mageworx-swatch-option");h.length>0?o.each(h,function(c,l){var m=o(l).attr("data-option-id"),f=o(l).attr("data-option-type-id");o(l).css("display")!="none"&&!a.isUndefined(t.options[m])&&!a.isUndefined(t.options[m].values)&&!a.isUndefined(t.options[m].values[f])&&!a.isUndefined(t.options[m].values[f].images)&&t.$element.closest("[data-option_id]").css("display")!="none"&&(p=o.extend(!0,p,t.options[m].values[f].images))}):o(t.$element).find("option").each(function(){var c=t.currentOptionId,l=o(this).val();l&&t.$element.closest("[data-option_id]").css("display")!="none"&&!a.isUndefined(t.options[c])&&!a.isUndefined(t.options[c].values)&&!a.isUndefined(t.options[c].values[l])&&!a.isUndefined(t.options[c].values[l].images)&&o(this).css("display")!="none"&&(p=o.extend(!0,p,t.options[c].values[l].images))}),a.extend(i,p)}}return i}},_addCandidateForReplacement:function(e,i){u.addCandidate(e,i)},_removeCandidateForReplacement:function(e){u.removeCandidate(e)},_removeUnselectedCandidates:function(e,i){var n=this,t=!1,s=!1;if(this.options.$element.is('input[type="checkbox"]')&&(t=!0),this.options.$element.is(":checked")||(s=!0),t&&s){var r=n.getOptionValueSortOrder(e,this.options.$element.val());u.removeCandidate(r)}else for(var d in this.options.options[e].values)if(!t&&!a.contains(i,d)&&i!=d){var r=n.getOptionValueSortOrder(e,d);u.removeCandidate(r)}},clearImagesContainer:function(){var e=this.options,i=this.getOptionGalleryContainer();!a.isUndefined(i)&&i instanceof jQuery&&i.html("")},_clearRadioImagesContainer:function(){var e=this.options,i=this.getOptionGalleryContainer(),n=i.parent().parent();n.find("input:radio").each(function(){o(this).parent().find(".option_images_gallery").html("")})},_isValueSelected:function(){var e=this.options;return this.getOGType()==this.getOGTypeOnceSelected()&&(e.$element.is(":checked")||(this.getOptionType()=="drop_down"||this.getOptionType()=="multiple")&&e.$element.val())},_resolveTemplateByOptionType:function(e){return this.options.templates[e]},getOptionType:function(){return a.isUndefined(this.options.options[this.getOptionId()])?"":this.options.options[this.getOptionId()].type},getOptionId:function(){return this.options.currentOptionId},getOGTypeDisabled:function(){return this.options.option_gallery_type.disabled},getOGTypeBesideOption:function(){return this.options.option_gallery_type.beside_option},getOGTypeOnceSelected:function(){return this.options.option_gallery_type.once_selected},getOGType:function(){return this.options.options[this.getOptionId()].mageworx_option_gallery},isEnabledOptionReplaceMode:function(){return this.options.options[this.getOptionId()].mageworx_option_image_mode==="1"},isEnabledOptionOverlayMode:function(){return this.options.options[this.getOptionId()].mageworx_option_image_mode==="3"},isEnabledAnyOptionOverlayMode:function(){var e=!1;return o.each(this.options.options,function(i,n){n.mageworx_option_image_mode==="3"&&(e=!0)}),e},getOptionGalleryContainer:function(){return this.options.$element.parent().find("."+this.options.imagesContainerClass)},isElementSelected:function(){var e=this.options.$element;return e.is('input:not([type="button"]):not([type="checkbox"]):not([type="radio"]):not([type="file"]), textarea, select')?Boolean(e.val()):e.is('input[type="radio"]')||e.is('input[type="checkbox"]')?e.is(":checked"):!1}}),o.mageworx.optionAdditionalImages});
