define(["jquery","dynamicOptionsDefaultCalculator","Magento_Catalog/js/price-utils","qTip","underscore","priceBox","jquery-ui-modules/widget","jquery/validate"],function(c,h,p,I,u){"use strict";return c.widget("mageworx.dynamicOptions",{options:{},original_regular_price_excl_tax:null,original_regular_price_incl_tax:null,original_final_price_excl_tax:null,original_final_price_incl_tax:null,extended_tier_prices:{},firstRun:function(i,t,e,o){this.priceBox=c(".price-box",r);var r=e.getFormElement(),s=e.options,d=c(s.optionsSelector,r);d.filter('input[type="text"], textarea').each(function(g,l){var x=c(l),n=p.findOptionId(x);c("#mageworx_dynamic_option_hint_icon_"+n).qtip({content:{text:c("#mageworx_dynamic_option_hint_"+n).html()},style:{classes:"qtip-light"},position:{target:!1}}),c("#mageworx_dynamic_option_hint_"+n).hide()})},applyChanges:function(i,t){var e=this,o=!1,r=1,s=i.getFormElement(),d=i.options,g=c(d.optionsSelector,s),l=this.options.options_data;if(l.length!==0){if(this.initProductPrice(t),g.filter('input[type="text"], textarea').each(function(m,a){var _=c(a),P=p.findOptionId(_),f=parseFloat(_.val());if(_.closest(".field").css("display")!="none"&&typeof l[P]!="undefined"){if(Number.isNaN(f)&&_.val()===""){o=!0;return}if(!c.validator.validateElement(_)){o=!0;return}l[P].value=f}}),o){t.regular_price_excl_tax=e.original_regular_price_excl_tax,t.regular_price_incl_tax=e.original_regular_price_incl_tax,t.final_price_excl_tax=e.original_final_price_excl_tax,t.final_price_incl_tax=e.original_final_price_incl_tax;return}if(r=h.calculate(l,this.options.price_per_unit),t.type_id==="configurable"){var x={};x.mwDynamicOptions={basePrice:{amount:r},finalPrice:{amount:r}},this.priceBox.trigger("updatePrice",x)}else{if(t.regular_price_excl_tax=e.original_regular_price_excl_tax+r,t.regular_price_incl_tax=e.original_regular_price_incl_tax+r,t.final_price_excl_tax=e.original_final_price_excl_tax+r,t.final_price_incl_tax=e.original_final_price_incl_tax+r,this.productPerItemRegularPriceExclTax=e.original_regular_price_excl_tax+r,this.productPerItemFinalPriceInclTax=e.original_regular_price_incl_tax+r,this.productPerItemFinalPriceExclTax=e.original_final_price_excl_tax+r,this.productPerItemFinalPriceInclTax=e.original_final_price_incl_tax+r,!u.isUndefined(t.extended_tier_prices)&&t.extended_tier_prices.length>0){var n=t.extended_tier_prices;u.each(n,function(m,a){t.extended_tier_prices[a].price_incl_tax=e.extended_tier_prices[a].price_incl_tax+r,t.extended_tier_prices[a].price_incl_tax=e.extended_tier_prices[a].price_incl_tax+r})}this.setProductPrice(i)}}},setProductPrice:function(i){i.getPriceDisplayMode()==1?(i.setProductRegularPrice(this.productPerItemRegularPriceExclTax),i.setProductFinalPrice(this.productPerItemFinalPriceExclTax),i.setAdditionalProductRegularPrice(this.productPerItemRegularPriceExclTax),i.setAdditionalProductFinalPrice(this.productPerItemFinalPriceExclTax)):(i.setProductRegularPrice(this.productPerItemRegularPriceInclTax),i.setProductFinalPrice(this.productPerItemFinalPriceInclTax),i.setAdditionalProductRegularPrice(this.productPerItemRegularPriceInclTax),i.setAdditionalProductFinalPrice(this.productPerItemFinalPriceInclTax)),i.setProductPriceExclTax(this.productPerItemFinalPriceExclTax),i.setAdditionalProductPriceExclTax(this.productPerItemFinalPriceExclTax)},initProductPrice:function(i){this.original_regular_price_excl_tax===null&&(this.original_regular_price_excl_tax=i.regular_price_excl_tax),this.original_regular_price_incl_tax===null&&(this.original_regular_price_incl_tax=i.regular_price_incl_tax),this.original_final_price_excl_tax===null&&(this.original_final_price_excl_tax=i.final_price_excl_tax),this.original_final_price_incl_tax===null&&(this.original_final_price_incl_tax=i.final_price_incl_tax),this.original_final_price_incl_tax===null&&(this.original_final_price_incl_tax=i.final_price_incl_tax),this.productPerItemRegularPriceExclTax=this.original_regular_price_excl_tax,this.productPerItemRegularPriceInclTax=this.original_regular_price_incl_tax,this.productPerItemFinalPriceExclTax=this.original_final_price_excl_tax,this.productPerItemFinalPriceInclTax=this.original_final_price_incl_tax,!u.isUndefined(i.extended_tier_prices)&&i.extended_tier_prices.length>0&&(this.extended_tier_prices=p.deepClone(i.extended_tier_prices))}}),c.mageworx.dynamicOptions});
