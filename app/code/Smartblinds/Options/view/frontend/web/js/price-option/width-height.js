define(["jquery","underscore","getSwatchSelectedProductId","priceUtils","mage/translate","Smartblinds_Options/js/price-option/width-height/calculations","Smartblinds_Options/js/model/price-calculator","Smartblinds_Options/js/model/system","Smartblinds_Options/js/model/option-params","mage/validation","priceOptions","jquery-ui-modules/widget"],function(t,v,_,F,u,g,w,c,y){"use strict";var p=t(window),T={},S=!1,b=!1;return t.widget("mage.priceOptionWidthHeight",{options:{formSelector:"#product_addtocart_form",valueFieldSelector:"input[type=hidden]",widthFieldSelector:"input[data-role=width]",heightFieldSelector:"input[data-role=height]",systemTypeSelector:"input[data-attr-name=system_type]",controlTypeSelector:"input[data-attr-name=control_type]",systemSizeSelector:"input[data-attr-name=system_size]",fabricSizeSelector:"input[data-attr-name=fabric_size]",progressButtonSelector:"[data-role=progress-button]"},_create:function(){this._initFields()._initEvents()._initOptionHandler()._addValidatorMethod()},_initFields:function(){return this.form=this.element.closest(this.options.formSelector),this.$labelValue=t(this.element).find("#value"),this.$form=t(this.form),this.$valueField=t(this.element.find(this.options.valueFieldSelector)),this.$widthField=t(this.element.find(this.options.widthFieldSelector)),this.$heightField=t(this.element.find(this.options.heightFieldSelector)),this.$progressButton=t(this.$form.find(this.options.progressButtonSelector)),c.init(this.$valueField),y.init(this.$valueField),this},_initEvents:function(){return this.$widthField.on("input",this._updateValueField.bind(this)),this.$widthField.on("focusout",this._validateField.bind(this)),this.$heightField.on("input",this._updateValueField.bind(this)),this.$heightField.on("focusout",this._validateField.bind(this)),this.$widthField.on("focusout",this._sendUpdateEvent.bind(this)),this.$heightField.on("focusout",this._sendUpdateEvent.bind(this)),p.on("swatches-click",this._updateValueField.bind(this)),p.on("swatches-click",this._addValidatorWidthHeight.bind(this)),p.on("swatches-click",this._handleSystemSizeAvailability.bind(this)),this.$progressButton.on("mousedown",this._updateValueField.bind(this)),this.$progressButton.on("mouseup",this._validateField.bind(this)),p.on("priceOptionWidthHeightUpdate",this._updateValueField.bind(this)),p.on("priceOptionWidthHeightValidate",this._validateField.bind(this)),p.on("priceOptionWidthHeightSendUpdate",this._sendUpdateEvent.bind(this)),t("body").hasClass("checkout-cart-configure")&&(this.$valueField.addClass("selected"),p.trigger("update-steps")),this},_initOptionHandler:function(){var i=this.$valueField.data("role"),s={optionHandlers:{}};return s.optionHandlers[i]=this._optionHandler.bind(this),this.form.priceOptions(s),this},_prepareInputValue:function(i){let s=i.val().replace(",",".");return s=s||0,parseInt(parseFloat(s)*10)},_isChainProduct:function(){let i=new URLSearchParams(window.location.hash.substring(1)),s=i.get("sku")?i.get("sku").toLowerCase():null;return s&&s.includes("chain")},_updateValueField:function(i,s,a){if(a)return;const o={width:this._prepareInputValue(this.$widthField),height:this._prepareInputValue(this.$heightField)};this.$valueField.val(JSON.stringify(o)),o.system_type=t(this.$form.find(this.options.systemTypeSelector)).val(),t(this.$form.find(this.options.controlTypeSelector)).length>0?o.control_type=t(this.$form.find(this.options.controlTypeSelector)).val():o.control_type=this._isChainProduct()?"chain":"motor",o.system_size=t(this.$form.find(this.options.systemSizeSelector)).val(),v.each(o,function(n,h){this.$valueField.data(h,n)},this),this._updatePlaceholders(o);const r=o.width/10,l=o.height/10;Number.isInteger(o.width)&&Number.isInteger(o.height)&&this.$labelValue.text(r+" x "+l+" cm");var d=c.get(),e=window.jsonConfig.systemTypeValues;e[d.systemType]=="tdbu"?t('.product-option-info-icon[data-option-modal="product_option_modal_motor_side"]').eq(0).closest(".product-option").addClass("motor_side-visible-0"):t('.product-option-info-icon[data-option-modal="product_option_modal_motor_side"]').eq(0).closest(".product-option").removeClass("motor_side-visible-0"),this.$valueField.trigger("change")},_sendUpdateEvent:function(){var i=this.$valueField.data("width"),s=this.$valueField.data("height");if(Number.isInteger(i)&&Number.isInteger(s)&&this.$widthField.valid()){var a=i/10,o=s/10;p.trigger("option-width-height-change",[a,o])}},_validateField:function(i){if(this.$widthField.is(":focus")||this.$heightField.is(":focus")){this.$valueField.removeClass("selected");return}this.$widthField.val(this.$widthField.val().replace(",",".")),this.$heightField.val(this.$heightField.val().replace(",",".")),this._handleSystemSizeAvailability(),this.$widthField.val()&&this.$heightField.val()&&this.$widthField.valid()?(this.$valueField.addClass("selected"),p.trigger("update-steps")):this.$valueField.removeClass("selected")},_handleSystemSizeAvailability:function(){const i=t(this.$form.find(this.options.systemSizeSelector)).parent();i.find("[data-option-id]").attr("disabled",!1).prop("disabled",!1);const s=window.jsonConfig.systemSizeValues,a=v.invert(s),o=a.small,r=a.medium;let l=c.get();if(!l)return;let d=null,e=parseInt(_());if(s[l.systemSize]==="medium"){if(b===!0)return;b=!0,i.find('[data-option-id="'+o+'"]').trigger("click"),e=parseInt(_()),d=c.get(),i.find('[data-option-id="'+r+'"]').trigger("click"),b=!1}const n=y.get(e,d);if(!n)return;l=n.system;const h=parseFloat(this.$valueField.data("width")),m=parseFloat(this.$valueField.data("height")),f=g.calcMaxWidth(n),$=g.calcMaxHeight(n);(h>f||m>$||parseFloat(n.product.thickness)>=.5&&h>=2e3)&&(s[l.systemSize]==="small"&&i.find('[data-option-id="'+r+'"]').trigger("click"),i.find('[data-option-id="'+o+'"]').attr("disabled",!0).prop("disabled",!0))},_updatePlaceholders:function(i){var s=c.get();if(!s)return;const a=window.jsonConfig.systemsPlaceholder[s.id];a.widthPlaceHolder!==""&&this.$widthField.attr("placeholder",a.widthPlaceHolder),a.heightPlaceHolder!==""&&this.$heightField.attr("placeholder",a.heightPlaceHolder)},_optionHandler:function(i,s){var a=F.findOptionId(i),o=s[a].prices,r="options["+a+"]",l={};const d=w.calculateWidthHeightFinalPrice();return d===null?(l[r]={},l):(o.basePrice.amount=d,o.finalPrice.amount=d,o.oldPrice.amount=d,o.oldPrice.amount_excl_tax=d,o.oldPrice.amount_incl_tax=d,l[r]=o,l)},_addValidatorWidthHeight:function(){let i=this.$valueField.data("width"),s=this.$valueField.data("height");if(i&&s){let a=c.getByType("motor"),o=c.getByType("chain");a&&i<a.minWidth&&a.isChainCustomerGroup==1?(t("#option-label-control_type-"+a.controlTypeData.attributeId+"-item-"+a.controlTypeData.options.chain).removeClass("disabled"),t("#option-label-control_type-"+a.controlTypeData.attributeId+"-item-"+a.controlTypeData.options.motor).addClass("disabled")):o&&i>o.maxWidth&&(t("#option-label-control_type-"+a.controlTypeData.attributeId+"-item-"+a.controlTypeData.options.motor).removeClass("disabled"),t("#option-label-control_type-"+a.controlTypeData.attributeId+"-item-"+a.controlTypeData.options.chain).addClass("disabled"))}},_addValidatorMethod:function(){var i=this;return t.validator.messages={required:u("Don't forget to fill in the width and height of your window recess here")},t.validator.addMethod("width-height",function(s,a){var o=y.get(),r=t(a),l=c.getByType("motor"),d=c.getByType("chain");if(!i.$valueField.data("width")||!i.$valueField.data("height"))return i.$progressButton.hasClass("progress-btn")?(r.data("error-message",u("Don't forget to fill in the width and height of your window recess here")),!1):!0;if(!o)return r.data("error-message",u("This product is unavailable")),!1;var e=o.system,n=i.$valueField.data("width"),h=i.$valueField.data("height"),m=g.calcMaxWidth(o),f=g.calcMaxHeight(o);if(!h||!n)return!1;if(h/n>3&&o.system.systemCategory!=="honeycomb_blinds")return r.data("error-message",u("Your product has a width/height ratio greater than 1:3. This is greater than our recommended ratio. Choose dimensions that fall within this ratio.")),!1;if(t(i.$form.find(i.options.controlTypeSelector)).length>0&&n<l.minWidth&&e.controlTypeData.options[e.controlType]!="chain"&&e.isChainCustomerGroup==1)t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.chain).removeClass("disabled"),t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.chain).trigger("click"),t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.motor).addClass("disabled"),console.log("De gekozen breedte van "+n/10+" cm is alleen mogelijk met een ketting bediend systeem.");else if(t(i.$form.find(i.options.controlTypeSelector)).length>0&&e.controlTypeData.options[e.controlType]=="chain"&&n>d.maxWidth)t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.motor).removeClass("disabled"),t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.motor).trigger("click"),t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.chain).addClass("disabled"),console.log("De gekozen breedte van "+n/10+" cm is niet mogelijk met een ketting bediend systeem.");else{if(n>m&&h>f)return r.data("error-message",u("Your product is too broad and therefore cannot be delivered. The maximum width for a product of %1 cm high is: %2 cm. Try a different fabric or choose different dimensions.").replace("%1",h/10).replace("%2",m/10)),!1;if(n<=m&&h>f)return r.data("error-message",u("Your product is too high and therefore cannot be delivered. The maximum height for a product of %1 cm wide is: %2 cm. Try a different fabric or choose different dimensions.").replace("%1",n/10).replace("%2",f/10)),!1;if(n>m&&h<=f)return r.data("error-message",u("Your product is too broad and therefore cannot be delivered. The maximum width for a product of %1 cm high is: %2 cm. Try a different fabric or choose different dimensions.").replace("%1",h/10).replace("%2",m/10)),!1;if(e.minHeight>h||e.minWidth>n)return r.data("error-message",u("Your product is too small and therefore cannot be delivered. The minimum width is %1 cm and the minimum height is %2 cm.").replace("%1",e.minWidth/10).replace("%2",e.minHeight/10)),!1;l&&n<l.minWidth&&e.isChainCustomerGroup==1?(t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.chain).removeClass("disabled"),t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.motor).addClass("disabled")):d&&n>d.maxWidth&&(t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.motor).removeClass("disabled"),t("#option-label-control_type-"+e.controlTypeData.attributeId+"-item-"+e.controlTypeData.options.chain).addClass("disabled"))}return!0},function(s,a){return t(a).data("error-message")}),this}}),t.mage.priceOptionWidthHeight});
