define(["jquery","ko","underscore","Magento_Ui/js/form/form","Magento_Checkout/js/model/quote","MageWorx_MultiFees/js/model/payment-fee","MageWorx_MultiFees/js/action/apply-fees","MageWorx_MultiFees/js/model/fee-messages","mage/translate","mage/url","mageUtils","uiRegistry","MageWorx_MultiFees/js/form/element/select","MageWorx_MultiFees/js/form/element/date","MageWorx_MultiFees/js/form/element/checkbox-set","MageWorx_MultiFees/js/form/element/textarea","MageWorx_MultiFees/js/form/element/hidden"],function(u,l,c,m,f,h,g,y,b,M,p,x){"use strict";var v=b("You need to select required additional fees to proceed to checkout"),d=l.observable(!1);function _(){var e,t,o,s;function a(n,r){var i;if(isNaN(n)&&isNaN(r)&&typeof n=="number"&&typeof r=="number"||n===r)return!0;if(typeof n=="function"&&typeof r=="function"||n instanceof Date&&r instanceof Date||n instanceof RegExp&&r instanceof RegExp||n instanceof String&&r instanceof String||n instanceof Number&&r instanceof Number)return n.toString()===r.toString();if(!(n instanceof Object&&r instanceof Object)||n.isPrototypeOf(r)||r.isPrototypeOf(n)||n.constructor!==r.constructor||n.prototype!==r.prototype||o.indexOf(n)>-1||s.indexOf(r)>-1)return!1;for(i in r)if(r.hasOwnProperty(i)!==n.hasOwnProperty(i)||typeof r[i]!=typeof n[i])return!1;for(i in n){if(r.hasOwnProperty(i)!==n.hasOwnProperty(i)||typeof r[i]!=typeof n[i])return!1;switch(typeof n[i]){case"object":case"function":if(o.push(n),s.push(r),!a(n[i],r[i]))return!1;o.pop(),s.pop();break;default:if(n[i]!==r[i])return!1;break}}return!0}if(arguments.length<1)return!0;for(e=1,t=arguments.length;e<t;e++)if(o=[],s=[],!a(arguments[0],arguments[e]))return!1;return!0}function j(e){var t="?";return c.each(e,function(o,s){t+=s+"="+o+"&"}),t.slice(0,-1)}return m.extend({defaults:{reloadUrl:M.build("multifees/checkout/refreshPayment")},currentMethod:null,currentShippingMethod:null,address:null,isLoading:d,shouldShow:l.observable(!1),initialize:function(){return this._super(),this.shouldShow(this.elems().length>0),this.initSubscriptions(),this},processTimer:!1,initSubscriptions:function(){var e=this;f.paymentMethod.subscribe(function(t){t&&t.method&&e.currentMethod!=t.method&&(e.currentMethod=t.method,e.updateContent())},null,"change"),f.billingAddress.subscribe(function(t){t!=null&&(e.address?e.isAddressesEqual(e.address,t)||(e.address=t,e.processTimer&&clearTimeout(e.processTimer),e.processTimer=setTimeout(function(){e.updateContent()},1e3)):(e.address=t,e.updateContent()))}),f.shippingMethod.subscribe(function(t){if(!(!t||!t.carrier_code||!t.method_code)){var o=t.carrier_code+"_"+t.method_code;e.currentShippingMethod!=o&&(e.currentShippingMethod=o,e.updateContent())}})},isAddressesEqual:function(e,t){var o=Object.assign({},e),s=Object.assign({},t);return _(o,s)},onSubmit:function(){if(this.source.set("params.invalid",!1),this.source.trigger("mageworxPaymentFeeForm.data.validate"),this.source.get("params.invalid"))y.addErrorMessage({message:v});else{this.clearSource();var e=this.source.get("mageworxPaymentFeeForm");e&&(d(!0),e.type=2,e=Object.assign(e,p.serialize(this.getDataForRequest())),g(e,d,"mageworx-payment-fee-form"))}},clearSource:function(){var e=this.source.get("mageworxPaymentFeeForm"),t=x.get({index:"mageworx-payment-fee-form-fieldset"}).elems().filter(function(n){return n.feeType==2});for(var o in e)if(o!=="type"){var s=!1;for(var a in t)if(t[a].inputName===o){s=!0;break}!s&&e.hasOwnProperty(o)&&delete e[o]}},isDisplayTitle:function(){return h.allData().is_display_title},updateContent:function(){var e=this.reloadData(),t=this,o=t.getChild("mageworx-payment-fee-form-fieldset");return!e||!o?this:(e.done(function(s){o.elems&&o.destroyChildren();var a=c.isEmpty(s)?[]:s.filter(r=>r.isVisibleInputType),n=!c.isEmpty(a);t.shouldShow(n),t.childCandidates=s,c.forEach(s,function(r,i){r.index=i,s[i]=require(r.component)(c.extend(r,r.config))}),o.insertChild(s),t.onSubmit()}),this)},reloadData:function(){if(this.currentMethod){var e=this.params,t=p.serialize(this.getDataForRequest()),o=this.reloadUrl,s=u.Deferred();return o||s.resolve(),u("body").trigger("processStart"),u.ajax({url:o+j(e),data:t,type:"post",dataType:"json",success:function(a){if(a.ajaxExpired&&(window.location.href=a.ajaxRedirect),!a.error)return s.resolve(a),!0;u("body").notification("clear"),u.each(a.messages,function(n,r){u("body").notification("add",{error:a.error,message:r,insertMethod:function(i){u(".page-main-actions").after(i)}})})},complete:function(){u("body").trigger("processStop")}}),s.promise()}},getDataForRequest:function(){var e=f.billingAddress()?c.pick(f.billingAddress(),function(t,o,s){return!c.isFunction(t)}):{};return{billingAddressData:e,form_key:window.FORM_KEY,payment_method:this.currentMethod,shipping_method:this.currentShippingMethod}}})});
