define(["jquery","uiComponent","ko","Magento_Customer/js/model/customer","Magento_Customer/js/action/check-email-availability","Magento_Customer/js/action/login","Magento_Checkout/js/model/quote","Magento_Checkout/js/checkout-data","Magento_Checkout/js/model/full-screen-loader","mage/validation"],function(i,m,g,c,h,f,u,a,d){"use strict";var o;return!a.getValidatedEmailValue()&&window.checkoutConfig.validatedEmailValue&&(a.setInputFieldEmailValue(window.checkoutConfig.validatedEmailValue),a.setValidatedEmailValue(window.checkoutConfig.validatedEmailValue)),o=a.getValidatedEmailValue(),o&&!c.isLoggedIn()&&(u.guestEmail=o),m.extend({defaults:{template:"GoMage_Checkout/form/element/email",email:a.getInputFieldEmailValue(),emailFocused:!1,isLoading:!1,isPasswordVisible:!1,listens:{email:"emailHasChanged",emailFocused:"validateEmail"},ignoreTmpls:{email:!0}},checkDelay:2e3,checkRequest:null,isEmailCheckComplete:null,isCustomerLoggedIn:c.isLoggedIn,forgotPasswordUrl:window.checkoutConfig.forgotPasswordUrl,emailCheckTimeout:0,passwordSelector:".create-account-password",checkboxSelector:".checkout-create-account",initConfig:function(){return this._super(),this.isPasswordVisible=this.resolveInitialPasswordVisibility(),this},initObservable:function(){return this._super().observe(["email","emailFocused","isLoading","isPasswordVisible"]),this},initialize:function(){this._super();var e=this;this.isPasswordVisible.subscribe(function(t){t?(i(e.passwordSelector).hide(),i(e.checkboxSelector).hide()):(i(e.checkboxSelector).show(),i(e.checkboxSelector).find(".custom-checkbox").is(":checked")&&i(e.passwordSelector).show())})},emailHasChanged:function(){var e=this;setTimeout(function(){i("form[data-role=email-with-possible-login]").find("#customer-email").rules("add",{messages:{required:i.mage.__("Don't forget to fill in your e-mail address")}})},e.checkDelay),clearTimeout(this.emailCheckTimeout),e.validateEmail()&&(u.guestEmail=e.email(),a.setValidatedEmailValue(e.email())),this.emailCheckTimeout=setTimeout(function(){e.validateEmail()?e.checkEmailAvailability():e.isPasswordVisible(!1)},e.checkDelay),a.setInputFieldEmailValue(e.email())},checkEmailAvailability:function(){this.validateRequest(),this.isEmailCheckComplete=i.Deferred(),this.isLoading(!0),this.checkRequest=h(this.isEmailCheckComplete,this.email()),i.when(this.isEmailCheckComplete).done(function(){this.isPasswordVisible(!1),a.setCheckedEmailValue("")}.bind(this)).fail(function(){this.isPasswordVisible(!0),a.setCheckedEmailValue(this.email())}.bind(this)).always(function(){this.isLoading(!1)}.bind(this))},validateRequest:function(){this.checkRequest!=null&&i.inArray(this.checkRequest.readyState,[1,2,3])&&(this.checkRequest.abort(),this.checkRequest=null)},validateEmail:function(e){var t="form[data-role=email-with-possible-login]",l=t+" input[name=username]",s=i(t),r,n;return s.validation(),e===!1&&!!this.email()?(n=!!i(l).valid(),n&&i(l).removeAttr("aria-invalid aria-describedby"),n):(r=s.validate(),r.check(l))},login:function(e){var t={},l=i(e).serializeArray();l.forEach(function(s){t[s.name]=s.value}),this.isPasswordVisible()&&i(e).validation()&&i(e).validation("isValid")&&(d.startLoader(),f(t).always(function(){d.stopLoader()}))},resolveInitialPasswordVisibility:function(){return a.getInputFieldEmailValue()!==""&&a.getCheckedEmailValue()!==""?!0:a.getInputFieldEmailValue()!==""?a.getInputFieldEmailValue()===a.getCheckedEmailValue():!1}})});
